import{cQ as j,cR as N,cS as O,cc as x,cT as D,cU as U,cV as V,cW as J,c as M,a as h,bR as B,b1 as H,ax as Y,j as L,cX as K,cY as W,cZ as z,b$ as F,c_ as P,c$ as G,ci as X,d0 as Z}from"./sanity.config-DAn9JPxb.js";import{c as ee}from"./PresentationToolGrantsCheck-B60ejTfH.js";import{i as T}from"./DisplayedDocumentBroadcaster-DzClfQnE.js";function te(t){if(Array.isArray(t)&&t.length>1&&t.includes("raw"))throw new TypeError('Invalid API perspective value: "raw". The raw-perspective can not be combined with other perspectives')}function re(t){if(te(t),Array.isArray(t))return t.includes("published")?t:[...t,"published"];switch(t){case"previewDrafts":case"drafts":return["drafts","published"];default:return["published"]}}function se(t,e){const s=re(e);function a(r){for(const n of s){let i=null;if(n.startsWith("r")&&(i=t({...r,_id:N(r._id,n)})),n==="drafts"&&(i=t({...r,_id:O(r._id)})),n==="published"&&(i=t({...r,_id:x(r._id)})),i)return{...i,_id:x(i._id),_originalId:i._id}}return null}return function(r){return a(r)}}function ne(t,e,s,a,r){if(!e)return t;const n=se(s,r),i=e.documents?.map?.(n)||[];return j(JSON.parse(JSON.stringify(t)),(l,d)=>{const y=D(d,e);if(!y)return l;const{mapping:o,pathSuffix:f}=y;if(o.type!=="value"||o.source.type!=="documentValue")return l;const p=e.documents[o.source.document],E=e.paths[o.source.path];if(p){const v=U(E+f),w=V(v),m=i[o.source.document];if(!m)return l;const g=m?J(m,w,l):l;return l===g?l:a(g,{cachedDocument:m,previousValue:l,sourceDocument:p,sourcePath:v})}return l})}function ie(t,e){switch(e.type){case"message":return{...t,messages:[...t.messages,e]};case"reconnect":case"restart":return{...t,messages:[],resets:t.resets+1};case"welcome":return t;default:throw Error(`Unknown event: ${e.type}`,{cause:e})}}const ae={messages:[],resets:0};function ue(t){const e=M.c(3),[s,a]=h.useReducer(ie,ae),[r,n]=h.useState(null);if(r!==null)throw r;let i,l;return e[0]!==t.live?(i=()=>{const d=t.live.events({includeDrafts:!0,tag:"presentation-loader"}).subscribe({next:a,error:y=>n(y instanceof Error?y:new Error("Unexpected error in useLiveEvents",{cause:y}))});return()=>d.unsubscribe()},l=[t.live],e[0]=t.live,e[1]=i,e[2]=l):(i=e[1],l=e[2]),h.useEffect(i,l),h.useDeferredValue(s)}const oe=(t,{previousValue:e})=>{if(typeof e=="string"){if(typeof t=="number")return`${t}`;if(Array.isArray(t)){if(t.length===0)return"";if(t.some(s=>typeof s=="object"&&K(s)))return W(t)}}return t};function ce(t,e,s){return`${t}:${e}:${JSON.stringify(s)}`}function le(t){if(t.queries.size<1)return t;const e=Date.now();if(!Array.from(t.heartbeats.values()).some(r=>r.heartbeat!==!1&&e>r.receivedAt+r.heartbeat))return t;const s=new Map,a=new Map;for(const[r,n]of t.heartbeats.entries())n.heartbeat!==!1&&e>n.receivedAt+n.heartbeat||(s.set(r,n),a.set(r,t.queries.get(r)));return{...t,queries:a,heartbeats:s}}function pe(t,{payload:e}){const s=ce(e.perspective,e.query,e.params),a={query:e.query,params:e.params,perspective:e.perspective},r=new Map(t.heartbeats);r.set(s,{receivedAt:Date.now(),heartbeat:e.heartbeat});let n=t.queries;return(!t.queries.has(s)||!T(t.queries.get(s),a))&&(n=new Map(t.queries),n.set(s,a)),{heartbeats:r,queries:n}}function fe(t,e){switch(e.type){case"query-listen":return pe(t,e);case"gc":return le(t);default:throw Error(`Unknown action: ${e.type}`,{cause:e})}}const de={queries:new Map,heartbeats:new Map};function he(){const t=M.c(4),[e,s]=h.useReducer(fe,de);let a,r;t[0]===Symbol.for("react.memo_cache_sentinel")?(a=()=>{const l=setInterval(()=>s({type:"gc"}),z);return()=>clearInterval(l)},r=[],t[0]=a,t[1]=r):(a=t[0],r=t[1]),h.useEffect(a,r);const n=h.useDeferredValue(e.queries);let i;return t[2]!==n?(i=[n,s],t[2]=n,t[3]=i):i=t[3],i}function _e(t){const e=M.c(28),{controller:s,perspective:a,onLoadersConnection:r,onDocumentsOnPage:n}=t,[i,l]=h.useState(),[d,y]=he(),o=B(),f=H();let p,E;e[0]!==s||e[1]!==f||e[2]!==y||e[3]!==n||e[4]!==r||e[5]!==o?(p=()=>{if(s){const c=s.createChannel({name:"presentation",connectTo:"loaders",heartbeat:!0},F().provide({actors:ee()}));return l(c),c.onStatus(r),c.on("loader/documents",u=>{u.projectId===o&&u.dataset===f&&n("loaders",u.perspective,u.documents)}),c.on("loader/query-listen",u=>{if(u.projectId===o&&u.dataset===f){if(typeof u.heartbeat=="number"&&u.heartbeat<P)throw new Error(`Loader query listen heartbeat interval must be at least ${P}ms`);y({type:"query-listen",payload:{perspective:u.perspective,query:u.query,params:u.params,heartbeat:u.heartbeat??!1}})}}),c.start()}return ye},E=[s,f,y,n,r,o],e[0]=s,e[1]=f,e[2]=y,e[3]=n,e[4]=r,e[5]=o,e[6]=p,e[7]=E):(p=e[6],E=e[7]),h.useEffect(p,E);let v;e[8]!==a?(v=Z(a)?G:{apiVersion:X},e[8]=a,e[9]=v):v=e[9];const w=Y(v);let m;e[10]!==w?(m=w.withConfig({resultSourceMap:"withKeyArraySelector"}),e[10]=w,e[11]=m):m=e[11];const g=m;let I,A;e[12]!==a||e[13]!==i||e[14]!==f||e[15]!==o?(I=()=>{i&&i.post("loader/perspective",{projectId:o,dataset:f,perspective:a})},A=[i,a,o,f],e[12]=a,e[13]=i,e[14]=f,e[15]=o,e[16]=I,e[17]=A):(I=e[16],A=e[17]),h.useEffect(I,A);const q=h.useDeferredValue(t.liveDocument),_=ue(g);let S;e[18]!==d?(S=[...d.entries()],e[18]=d,e[19]=S):S=e[19];let b;return e[20]!==g||e[21]!==i||e[22]!==f||e[23]!==q||e[24]!==_||e[25]!==o||e[26]!==S?(b=L.jsx(L.Fragment,{children:S.map(c=>{const[u,R]=c,{query:$,params:Q,perspective:k}=R;return L.jsx(C,{projectId:o,dataset:f,perspective:k,query:$,params:Q,comlink:i,client:g,liveDocument:q,liveEventsMessages:_.messages},`${_.resets}:${u}`)})}),e[20]=g,e[21]=i,e[22]=f,e[23]=q,e[24]=_,e[25]=o,e[26]=S,e[27]=b):b=e[27],b}function ye(){}function me(t){const e=M.c(20),{projectId:s,dataset:a,perspective:r,query:n,client:i,liveDocument:l,params:d,comlink:y,liveEventsMessages:o}=t,{result:f,resultSourceMap:p,syncTags:E}=be({client:i,liveDocument:l,params:d,perspective:r,query:n,liveEventsMessages:o})||{};let v;e[0]!==a||e[1]!==s?(v=(I,A,q,_,S,b,c)=>{I?.post("loader/query-change",{projectId:s,dataset:a,perspective:A,query:q,params:_,result:S,resultSourceMap:b,tags:c})},e[0]=a,e[1]=s,e[2]=v):v=e[2];const w=h.useEffectEvent(v);let m;e[3]!==y||e[4]!==w||e[5]!==d||e[6]!==r||e[7]!==n||e[8]!==f||e[9]!==p||e[10]!==E?(m=()=>{p&&w(y,r,n,d,f,p,E)},e[3]=y,e[4]=w,e[5]=d,e[6]=r,e[7]=n,e[8]=f,e[9]=p,e[10]=E,e[11]=m):m=e[11];let g;return e[12]!==y||e[13]!==d||e[14]!==r||e[15]!==n||e[16]!==f||e[17]!==p||e[18]!==E?(g=[y,d,r,n,f,p,E],e[12]=y,e[13]=d,e[14]=r,e[15]=n,e[16]=f,e[17]=p,e[18]=E,e[19]=g):g=e[19],h.useEffect(m,g),null}const C=h.memo(me);C.displayName="Memo(QuerySubscription)";function be(t){const e=M.c(30),{liveDocument:s,client:a,query:r,params:n,perspective:i,liveEventsMessages:l}=t,[d,y]=h.useState(null),[o,f]=h.useState(null),[p,E]=h.useState(void 0);let v;e[0]!==l?(v=()=>new Set(l.map(ve)),e[0]=l,e[1]=v):v=e[1];const[w]=h.useState(v);let m;if(e[2]!==l||e[3]!==w||e[4]!==p){let b;e[6]!==w?(b=R=>!w.has(R.id),e[6]=w,e[7]=b):b=e[7];const c=l.filter(b);let u;e[8]!==p?(u=R=>R.tags.some($=>p?.includes($)),e[8]=p,e[9]=u):u=e[9],m=c.findLast(u),e[2]=l,e[3]=w,e[4]=p,e[5]=m}else m=e[5];const g=m?.id,[I,A]=h.useState(null);if(I)throw I;let q,_;e[10]!==a||e[11]!==g||e[12]!==n||e[13]!==i||e[14]!==r?(q=()=>{const b=new AbortController;return a.fetch(r,n,{lastLiveEventId:g,tag:"presentation-loader",signal:b.signal,perspective:i,filterResponse:!1,returnQuery:!1}).then(c=>{h.startTransition(()=>{y(u=>T(u,c.result)?u:c.result),f(u=>T(u,c.resultSourceMap)?u:c.resultSourceMap),E(u=>T(u,c.syncTags)?u:c.syncTags)})}).catch(c=>{(typeof c!="object"||c?.name!=="AbortError")&&A(c)}),()=>{b.abort()}},_=[a,g,n,i,r],e[10]=a,e[11]=g,e[12]=n,e[13]=i,e[14]=r,e[15]=q,e[16]=_):(q=e[15],_=e[16]),h.useEffect(q,_);let S;e:{if(s&&o){let c;e[17]!==s||e[18]!==i||e[19]!==d||e[20]!==o?(c=ge(s,d,i,o),e[17]=s,e[18]=i,e[19]=d,e[20]=o,e[21]=c):c=e[21];let u;e[22]!==o||e[23]!==p||e[24]!==c?(u={result:c,resultSourceMap:o,syncTags:p},e[22]=o,e[23]=p,e[24]=c,e[25]=u):u=e[25],S=u;break e}let b;e[26]!==d||e[27]!==o||e[28]!==p?(b={result:d,resultSourceMap:o,syncTags:p},e[26]=d,e[27]=o,e[28]=p,e[29]=b):b=e[29],S=b}return S}function ve(t){return t.id}function ge(t,e,s,a){if(s==="raw")throw new Error("turboChargeResultIfSourceMap does not support raw perspective");return ne(e,a,r=>!r._projectId&&t?._id&&x(t._id)===x(r._id)?typeof t._id=="string"&&typeof r._type=="string"?t:{...t,_id:t._id||r._id,_type:t._type||r._type}:null,oe,Array.isArray(s)?s.filter(Boolean):s)}export{_e as default,ge as turboChargeResultIfSourceMap};
